# Yikai CMS Nginx Configuration
# 将以下配置添加到你的 server 块中

# 禁止访问隐藏文件
location ~ /\. {
    deny all;
}

# 禁止访问config目录
location ^~ /config/ {
    deny all;
}

# 禁止访问storage目录（SQLite数据库）
location ^~ /storage/ {
    deny all;
}

# 安装完成后禁止访问install目录
location ^~ /install/ {
    if (-f $document_root/installed.lock) {
        return 403;
    }
}

# 伪静态规则

# 栏目列表页 (ID格式)
location ~ ^/list/(\d+)\.html$ {
    rewrite ^/list/(\d+)\.html$ /list.php?id=$1 last;
}

location ~ ^/list/(\d+)/page/(\d+)\.html$ {
    rewrite ^/list/(\d+)/page/(\d+)\.html$ /list.php?id=$1&page=$2 last;
}

# 栏目列表页 (slug格式带分页)
location ~ ^/([a-z0-9_-]+)/page/(\d+)\.html$ {
    rewrite ^/([a-z0-9_-]+)/page/(\d+)\.html$ /list.php?slug=$1&page=$2 last;
}

# 列表页 (ID格式带分页)
location ~ ^/list/(\d+)/page/(\d+)\.html$ {
    rewrite ^/list/(\d+)/page/(\d+)\.html$ /list.php?id=$1&page=$2 last;
}

# 详情页 (ID格式)
location ~ ^/detail/(\d+)\.html$ {
    rewrite ^/detail/(\d+)\.html$ /detail.php?id=$1 last;
}

# 产品分类页
location ~ ^/product/([a-z0-9_-]+)/page/(\d+)\.html$ {
    rewrite ^/product/([a-z0-9_-]+)/page/(\d+)\.html$ /list.php?slug=product&cat=$1&page=$2 last;
}

location ~ ^/product/([a-z0-9_-]+)\.html$ {
    rewrite ^/product/([a-z0-9_-]+)\.html$ /list.php?slug=product&cat=$1 last;
}

# 产品详情页 (ID格式)
location ~ ^/product/(\d+)\.html$ {
    rewrite ^/product/(\d+)\.html$ /product.php?id=$1 last;
}

# 单页 (ID格式)
location ~ ^/page/(\d+)\.html$ {
    rewrite ^/page/(\d+)\.html$ /page.php?id=$1 last;
}

# 二级单页 (slug格式: /parent/child.html)
location ~ ^/([a-z0-9_-]+)/([a-z0-9_-]+)\.html$ {
    rewrite ^/([a-z0-9_-]+)/([a-z0-9_-]+)\.html$ /page.php?parent=$1&slug=$2 last;
}

# 一级页面 (slug格式: /slug.html)
location ~ ^/([a-z0-9_-]+)\.html$ {
    rewrite ^/([a-z0-9_-]+)\.html$ /page.php?slug=$1 last;
}

# 联系页面
location = /contact.html {
    rewrite ^ /contact.php last;
}

# PHP 处理
location ~ \.php$ {
    fastcgi_pass 127.0.0.1:9000;
    fastcgi_index index.php;
    fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
    include fastcgi_params;
}

# 静态文件缓存
location ~* \.(jpg|jpeg|png|gif|ico|css|js|webp|svg|woff|woff2|ttf|eot)$ {
    expires 30d;
    add_header Cache-Control "public, immutable";
}

# 默认处理
location / {
    try_files $uri $uri/ /index.php?$query_string;
}

# ============================================
# 完整示例配置（phpStudy 面板格式）
# ============================================
#
# server {
#     listen 80;
#     server_name www.example.com example.com;
#     root /path/to/ikaicms;
#     index index.php index.html;
#
#     # 禁止访问隐藏文件
#     location ~ /\. {
#         deny all;
#     }
#
#     # 禁止访问敏感目录
#     location ^~ /config/ {
#         deny all;
#     }
#
#     location ^~ /storage/ {
#         deny all;
#     }
#
#     # 伪静态
#     location ~ ^/list/(\d+)\.html$ {
#         rewrite ^/list/(\d+)\.html$ /list.php?id=$1 last;
#     }
#
#     location ~ ^/detail/(\d+)\.html$ {
#         rewrite ^/detail/(\d+)\.html$ /detail.php?id=$1 last;
#     }
#
#     location ~ ^/page/(\d+)\.html$ {
#         rewrite ^/page/(\d+)\.html$ /page.php?id=$1 last;
#     }
#
#     # PHP处理
#     location ~ \.php$ {
#         fastcgi_pass 127.0.0.1:9000;
#         fastcgi_index index.php;
#         fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
#         include fastcgi_params;
#     }
#
#     # 静态文件
#     location ~* \.(jpg|jpeg|png|gif|ico|css|js)$ {
#         expires 30d;
#     }
#
#     # 默认
#     location / {
#         try_files $uri $uri/ /index.php?$query_string;
#     }
# }
